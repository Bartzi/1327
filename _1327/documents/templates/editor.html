{% load static %}
{% load i18n %}
{% load bootstrap3 %}

	<h2>{% trans "Edit page" %}</h2>

    {% if form.autosave %}
		<div class="alert alert-danger alert-margin-bottom" role="alert">{% blocktrans with date=form.autosave_date %}This document was autosaved on {{ date }}{% endblocktrans %}, {% trans "you can restore unsaved changes:" %} <a href="{{ document.get_edit_url }}?restore" class="btn-sm btn-default" role="button">{% trans "Click here" %}</a></div>
	{% endif %}

	{% for new_autosaved_page in new_autosaved_pages %}
		<div class="alert alert-danger alert-margin-bottom" role="alert">{% blocktrans with date=new_autosaved_page.created %}There is a new document autosaved on {{ date }}{% endblocktrans %}, {% trans "you can restore this unsaved page:" %} <a href="{{ new_autosaved_page.get_edit_url }}?restore" class="btn-sm btn-default" role="button">{% trans "Click here" %}</a></div>
	{%  endfor %}

	<form action="{{ document.get_edit_url }}" method="post" class="form-horizontal" role="form" id="document-form">
		{% bootstrap_form form layout='horizontal' %}
		{% csrf_token %}
		{% buttons %}
		<div class="col-md-offset-2 col-md-9">
			<button type="submit" class="btn btn-primary">
				{% bootstrap_icon "floppy-disk" %} {% trans 'Save' %}
			</button>
		</div>
		{% endbuttons %}
	</form>

	<h2>{% trans "Preview" %}</h2>
	<div class="divider"></div>
	<div id="text-preview"></div>

	<div class="modal fade ontop" id="selectImageAttachment" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<div class="modal-title">{% trans "Select Image:" %}</div>
				</div>
				<div class="modal-body">
					<select class="form-control" id="attachmentModalSelect"></select>
					<div class="divider"></div>
					<h2>Preview</h2>
					<div class="preview">
						<img id="attachment-preview" style="width: 100%; height: 100%;" />
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" id="setImage">{% trans "OK" %}</button>
				</div>
			</div>
		</div>
	</div>

	<!-- mandatory script include -->
	<script type="text/javascript" src="{% static 'js/markdown.js' %}"></script>
	<script type="text/javascript" src="{% static 'js/jquery.hotkeys.js' %}"></script>
	<script type="text/javascript" src="{% static 'bootstrap-markdown/js/bootstrap-markdown.js' %}"></script>
	<script>
		$("#id_text").removeClass('form-control').markdown({
			autofocus:true,
			resize:"both",
			hiddenButtons: ["cmdPreview", "cmdImage"],
			onChange: function(e) {
				$('#text-preview').html(markdown.toHTML($('#id_text').val()));
			},
			onShow: function(e) {
				this.onChange(e);
			},
			additionalButtons: [
				// exchange the old image button by a new button
				[{
					name: "ImageGroup",
					data: [{
						name: "cmdAddImage",
						toggle: false,
						title: "Add Image",
						icon: "glyphicon glyphicon-picture",
						callback: function (e) {
							// get all attachments
							$.getJSON(
								"{% url "documents:get_attachments" document.id %}",
								{},
								function (data, textStatus, jqXHR) {
									// prepare the select in the modal
									var select = $('#attachmentModalSelect');
									if ($.isEmptyObject(data)) {
										// if there are no pictures disable the select
										select.attr('disabled', 'disabled');
										return;
									} else {
										select.attr('disabled', false);
									}
									var options = select.prop('options');
									$('option', select).remove();
									$.each(data, function (val, text) {
										options[options.length] = new Option(text, val);
									});
									// trigger the change event in order to show the preview of the pre selected
									// image
									select.trigger('change');
							});

							var modalItem = $('#selectImageAttachment');
							modalItem.modal();

							// set the click handler on the ok button that adds the image to the text
							// and closes the modal
							var setButton = $('#setImage');
							setButton.off('click');
							setButton.on("click", function (event) {
								var select = $('#attachmentModalSelect');
								if (select.attr('disabled')) {
									modalItem.modal('hide');
									return;
								}
								// find the right spot to insert the text and create the correct markdown
								var selectedAttachment = select.val();
								var chunk = "![Image Alt]({% url 'documents:download_attachment' %}?attachment_id=" + selectedAttachment + "&embed=True)";
								e.replaceSelection(chunk);
								var cursor = e.getSelection();

								e.setSelection(cursor, cursor + chunk.length);
								modalItem.modal('hide');
								$('#id_text').trigger('change');
							});
						}
					}]
				}]
			]
		});

		// handler to update the preview in the modal
		$('#attachmentModalSelect').on('change', function (event) {
			var selectedAttachment = $(this).val();
			$('#attachment-preview').attr('src', "{% url 'documents:download_attachment' %}?attachment_id=" + selectedAttachment + "&embed=True");
		});

		var text = $('#id_text').val();
		function save() {
			if(text != $('#id_text').val()) {
				text = $('#id_text').val();

				var form = $('#document-form');
				var serializedData = form.serialize();

				$.ajax({
					url: "{% url 'information_pages:autosave' document.url_title %}",
					type: "post",
					data: serializedData
				});
			}
			setTimeout(function() { save(); }, 10000);
		}
		save();
	</script>
