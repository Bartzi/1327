{% load static %}
{% load i18n %}
{% load bootstrap3 %}

	<h2>{% trans "Edit page" %}</h2>

	{% if form.errors %}
		<div class="alert alert-danger alert-margin-bottom" role="alert">{% trans "Please provide the missing information" %}</div>
	{% endif %}

    {% if form.autosave %}
		<div class="alert alert-danger alert-margin-bottom" role="alert">{% trans "This document was autosaved on" %} {{ form.autosave_date }}{% trans ", you can restore unsaved changes:" %} <a href="{{ edit_url }}?restore" class="btn-sm btn-default" role="button">{% trans "Click here" %}</a></div>
	{% endif %}
	
	<form class="form-horizontal" action="{{ edit_url }}" method="post" role="form" id="document-form">
		{% csrf_token %}
		<div class="form-group {% if 'title' in form.errors %}has-error{% endif %}">
			<label for="inputTitle" class="col-sm-2 control-label">{% trans "Title" %}</label>
			<div class="col-sm-9">
				<input type="text" class="form-control" name="title" value="{{ form.data.title }}" placeholder="{% trans 'Your Title...' %}">
			</div>
		</div>
		<div class="form-group {% if 'text' in form.errors %}has-error{% endif %}">
			<label for="inputText" class="col-sm-2 control-label">{% trans "Text" %}</label>
			<div class="col-sm-9">
				<textarea class="form-control" name="text" id="inputText" rows=20 placeholder="{% trans 'Your Text...' %}">{{ form.data.text }}</textarea>
			</div>
		</div>
		<div class="form-group {% if 'comment' in form.errors %}has-error{% endif %}">
			<label for="inputComment" class="col-sm-2 control-label">{% trans "Comment" %}</label>
			<div class="col-sm-9">
				<input type="text" class="form-control" name="comment" value="{% if document.initial %}{% trans "Created document" %}{% else %}{{ form.data.comment }}{% endif %}" placeholder="{% trans 'What did you do?' %}">
			</div>
		</div>
		<div class="form-group">
			<div class="col-md-offset-2 col-md-4">
				<button type="submit" class="btn btn-primary">
					<i class="glyphicon glyphicon-floppy-disk"></i> {% trans 'Save' %}
				</button>
			</div>
		</div>
	</form>

	<h2>{% trans "Preview" %}</h2>
	<div class="divider"></div>
	<div id="text-preview"></div>

	<!-- mandatory script include -->
	<script type="text/javascript" src="{% static 'js/markdown.js' %}"></script>
	<script type="text/javascript" src="{% static 'bootstrap-markdown/js/bootstrap-markdown.js' %}"></script>
	<script>
		$("#inputText").markdown({
			autofocus:true,
			resize:"both",
			hiddenButtons:"cmdPreview",
			onChange: function(e) {
				$('#text-preview').html(markdown.toHTML($('#inputText').val()));
			},
			onShow: function(e) {
				this.onChange(e);
			}
		});
		var text = $('#inputText').val();
		function save() {
			if(text != $('#inputText').val()) {
				text = $('#inputText').val();

				var form = $('#document-form');
				var serializedData = form.serialize();

				$.ajax({
					url: "{% url 'information_pages:autosave' document.url_title %}",
					type: "post",
					data: serializedData
				});
			}
			setTimeout(function() { save(); }, 10000);
		}
		save();
	</script>
